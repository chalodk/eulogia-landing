<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eulogia.cl - Landing Page</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Markdown rendering libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-W5S3G2TL');</script>
    <!-- End Google Tag Manager -->
    <!-- Meta Pixel Code -->
<script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '683292484856086');
    fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=683292484856086&ev=PageView&noscript=1"
    /></noscript>
    <!-- End Meta Pixel Code -->
    <meta name="facebook-domain-verification" content="tkqfnkrv8e58lsmhafjvr02ikmpsg2" />
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W5S3G2TL"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <a href="#inicio" class="logo">
                <img src="https://afqnrbwwkseseegfreyr.supabase.co/storage/v1/object/public/eulogia/Logo%20Eulogia.png" alt="Eulogia Logo">
            </a>
            <nav class="nav">
                <ul class="nav-menu" id="navMenu">
                    <li><a href="#inicio" class="nav-link">Inicio</a></li>
                    <li><a href="#servicios" class="nav-link">Servicios</a></li>
                    <li><a href="#contacto" class="nav-link">Contacto</a></li>
                    <li><a href="https://app.eulogia.cl" class="nav-link nav-link-login" target="_blank" rel="noopener noreferrer">Iniciar sesiÃ³n</a></li>
                </ul>
                <button class="nav-toggle" id="navToggle" aria-label="Toggle menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </nav>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero" id="inicio">
        <div class="hero-overlay"></div>
        <div class="hero-content">
            <h1 class="slogan">Â¿Problemas para subir documentos a la DT?</h1>
            <p class="tagline">Evita multas. Nosotros los subimos por ti en menos de 4 horas, sin errores y con respaldo legal.</p>
            <a href="https://app.eulogia.cl" class="btn-cta">Comienza ahora</a>
            <a href="#contacto" class="btn-contacto">Contacto</a>
        </div>
    </section>

    <!-- Features Section -->
    <section class="features" id="servicios">
        <h2 class="contact-title">100% garantizado.</h2>
        <h3 class="contact-title">Sabemos exactamente como cumplir a tiempo las exigencias de la DT.</h3>

        <div class="features-container">
            
            <div class="features-image">
                <img src="https://afqnrbwwkseseegfreyr.supabase.co/storage/v1/object/public/eulogia/landing/4_vert-cal.png" alt="Eulogia">
            </div>
            <div class="features-content">
                <ul class="features-list">
                    <li>
                        <h3>Carga de todos tus contratos en un par de horas</h3>
                    </li>
                    <li>
                        <h3>Genera anexos de forma masiva</h3>
                    </li>
                    <li>
                        <h3>Recibe todos los comprobantes en tu correo o en una carpeta compartida</h3>
                    </li>
                     <li>
                        <h3>Revisamos y corrigemos errores antes de cargar</h3>
                    </li>
                </ul>
            </div>
        </div>
    </section>
    <!-- Trust Section -->
    <section class="trust" id="trust">
        <div class="trust-container">
            <p class="trust-text">+25 aÃ±os de experiencia en cumplimiento laboral</p>
            <a href="https://www.linkedin.com/company/agrolaboral/" target="_blank" rel="noopener noreferrer" class="trust-logo-link">
                <img src="https://dcdn-us.mitiendanube.com/stores/006/769/712/themes/common/logo-2082226531-1759025763-d1bec80528cda5b5587a6ed5c81d3a0f1759025763-480-0.webp" alt="Agrolaboral" class="trust-logo">
                <svg class="linkedin-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                </svg>
            </a>
        </div>
    </section>
    <!-- Contact Section -->
    <section class="contact" id="contacto">
        <div class="contact-container">
            <h2 class="contact-title">ContÃ¡ctanos</h2>
            <p class="contact-subtitle">Estamos aquÃ­ para ayudarte con tus necesidades de cumplimiento laboral</p>
            
            <div class="contact-content">
                <!-- Contact Form -->
                <div class="contact-form-wrapper">
                    <h3>EnvÃ­anos un mensaje</h3>
                    <form class="contact-form" id="contactForm">
                        <div class="form-group">
                            <label for="nombre">Nombre completo</label>
                            <input type="text" id="nombre" name="nombre" required>
                        </div>
                        <div class="form-group">
                            <label for="email">Correo electrÃ³nico</label>
                            <input type="email" id="email" name="email" required>
                        </div>
                        <div class="form-group">
                            <label for="empresa">Empresa</label>
                            <input type="text" id="empresa" name="empresa">
                        </div>
                        <div class="form-group">
                            <label for="telefono">TelÃ©fono</label>
                            <input type="tel" id="telefono" name="telefono">
                        </div>
                        <div class="form-group">
                            <label for="mensaje">Mensaje</label>
                            <textarea id="mensaje" name="mensaje" rows="5" required></textarea>
                        </div>
                        <button type="submit" class="btn-submit" id="submitBtn">
                            <span class="btn-text">Enviar mensaje</span>
                            <span class="btn-loader" style="display: none;">Enviando...</span>
                        </button>
                        <div class="form-message" id="formMessage" style="display: none;"></div>
                    </form>
                </div>

                <!-- Contact Info -->
                <div class="contact-info-wrapper">
                    <h3>InformaciÃ³n de contacto</h3>
                    <div class="contact-info">
                        <div class="contact-item">
                            <h4>Correo electrÃ³nico</h4>
                            <a href="mailto:consultas@eulogia.cl">consultas@eulogia.cl</a>
                        </div>
                        
                        <div class="contact-item">
                            <h4>WhatsApp</h4>
                            <a href="https://wa.me/56998261235?text=Hola!%20me%20interesa%20saber%20mÃ¡s%20de%20Eulogia%20y%20como%20puede%20ayudarme%20con%20el%20cumplimiento%20laboral" 
                               target="_blank" 
                               rel="noopener noreferrer" 
                               class="whatsapp-link">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                                </svg>
                                Chatea con nosotros
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2025 Eulogia.cl - Todos los derechos reservados</p>
        <p>Hecho en Chile con <3 </p>
 
    </footer>

    <!-- Chatbot Widget -->
    <div class="chatbot-container" id="chatbotContainer">
        <div class="chatbot-window" id="chatbotWindow">
            <div class="chatbot-header">
                <div class="chatbot-header-content">
                    <div class="chatbot-avatar">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                        </svg>
                    </div>
                    <div class="chatbot-header-text">
                        <h4>Eulogia</h4>
                        <span class="chatbot-status">En lÃ­nea</span>
                    </div>
                </div>
                <button class="chatbot-close" id="chatbotClose" aria-label="Cerrar chat">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="chatbot-messages" id="chatbotMessages">
                <div class="chatbot-message chatbot-message-bot">
                    <div class="message-content">
                        <p>Â¡Hola! ðŸ‘‹ Soy Eulogia. Â¿En quÃ© puedo ayudarte hoy?</p>
                    </div>
                </div>
            </div>
            <div class="chatbot-input-container">
                <input type="text" 
                       id="chatbotInput" 
                       class="chatbot-input" 
                       placeholder="Escribe tu mensaje..." 
                       autocomplete="off">
                <button class="chatbot-send" id="chatbotSend" aria-label="Enviar mensaje">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
        </div>
        <div class="chatbot-invitation" id="chatbotInvitation">
            <p>Hola! Soy Eulogia, Â¿Tienes dudas sobre nuestros servicios?</p>
        </div>
        <button class="chatbot-toggle" id="chatbotToggle" aria-label="Abrir chat">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            <span class="chatbot-badge" id="chatbotBadge" style="display: none;">1</span>
        </button>
    </div>

    <script>
        // Mobile menu toggle
        const navToggle = document.getElementById('navToggle');
        const navMenu = document.getElementById('navMenu');

        navToggle.addEventListener('click', function() {
            navMenu.classList.toggle('active');
            navToggle.classList.toggle('active');
        });

        // Close menu when clicking on a link
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function() {
                navMenu.classList.remove('active');
                navToggle.classList.remove('active');
            });
        });

        // Smooth scroll with modern easing effect
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const targetId = this.getAttribute('href');
                if (targetId === '#') return;
                
                const targetElement = document.querySelector(targetId);
                if (targetElement) {
                    const targetPosition = targetElement.getBoundingClientRect().top + window.pageYOffset;
                    const startPosition = window.pageYOffset;
                    const distance = targetPosition - startPosition;
                    const duration = 1000; // 1 second
                    let start = null;

                    // Easing function for smooth animation (ease-in-out-cubic)
                    function easeInOutCubic(t) {
                        return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
                    }

                    function animation(currentTime) {
                        if (start === null) start = currentTime;
                        const timeElapsed = currentTime - start;
                        const progress = Math.min(timeElapsed / duration, 1);
                        const ease = easeInOutCubic(progress);
                        
                        window.scrollTo(0, startPosition + distance * ease);
                        
                        if (timeElapsed < duration) {
                            requestAnimationFrame(animation);
                        }
                    }

                    requestAnimationFrame(animation);
                }
            });
        });

        // Handle contact form submission
        const contactForm = document.getElementById('contactForm');
        const submitBtn = document.getElementById('submitBtn');
        const btnText = submitBtn.querySelector('.btn-text');
        const btnLoader = submitBtn.querySelector('.btn-loader');
        const formMessage = document.getElementById('formMessage');

        contactForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form data
            const formData = new FormData(this);
            const data = {
                nombre: formData.get('nombre'),
                email: formData.get('email'),
                empresa: formData.get('empresa') || '',
                telefono: formData.get('telefono') || '',
                mensaje: formData.get('mensaje')
            };

            // Disable submit button and show loading state
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            btnLoader.style.display = 'inline';
            formMessage.style.display = 'none';

            try {
                // Basic Auth credentials
                const username = 'eulogia';
                const password = 'm4rkzv1v3';
                const credentials = btoa(`${username}:${password}`);
                
                // Send data to webhook using POST method with Basic Auth
                const response = await fetch('https://n8n.agroanalytics.cl/webhook/38cbe751-76f5-4cee-803c-5ca1df402638', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Authorization': `Basic ${credentials}`
                    },
                    body: JSON.stringify(data)
                });

                // Log response for debugging
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);

                if (response.ok) {
                    // Success
                    formMessage.textContent = 'Â¡Gracias por tu mensaje! Nos pondremos en contacto contigo pronto.';
                    formMessage.className = 'form-message success';
                    formMessage.style.display = 'block';
                    
                    // Reset form
                    this.reset();
                    
                    // Scroll to message
                    formMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    // Get error details
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    console.error('Status:', response.status);
                    
                    let errorMessage = 'Hubo un error al enviar tu mensaje. ';
                    if (response.status === 401) {
                        errorMessage += 'Error de autenticaciÃ³n. Por favor, contacta al administrador.';
                    } else if (response.status === 403) {
                        errorMessage += 'Acceso denegado. Por favor, contacta al administrador.';
                    } else {
                        errorMessage += 'Por favor, intenta nuevamente o contÃ¡ctanos directamente.';
                    }
                    
                    throw new Error(errorMessage);
                }
            } catch (error) {
                // Error
                formMessage.textContent = error.message || 'Hubo un error al enviar tu mensaje. Por favor, intenta nuevamente o contÃ¡ctanos directamente.';
                formMessage.className = 'form-message error';
                formMessage.style.display = 'block';
                console.error('Error:', error);
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                btnText.style.display = 'inline';
                btnLoader.style.display = 'none';
            }
        });

        // Chatbot functionality
        const chatbotToggle = document.getElementById('chatbotToggle');
        const chatbotWindow = document.getElementById('chatbotWindow');
        const chatbotClose = document.getElementById('chatbotClose');
        const chatbotInput = document.getElementById('chatbotInput');
        const chatbotSend = document.getElementById('chatbotSend');
        const chatbotMessages = document.getElementById('chatbotMessages');
        const chatbotBadge = document.getElementById('chatbotBadge');

        // Webhook configuration - Replace with your n8n chatbot webhook URL
        const CHATBOT_WEBHOOK_URL = 'https://n8n.agroanalytics.cl/webhook/96e1010a-9380-47f0-b9d7-915068513e80/chat';
        const CHATBOT_USERNAME = 'eulogia';
        const CHATBOT_PASSWORD = 'm4rkzv1v3';

        // Session ID management
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function getSessionId() {
            const STORAGE_KEY = 'chatbot_session_id';
            let sessionId = localStorage.getItem(STORAGE_KEY);
            if (!sessionId) {
                sessionId = generateSessionId();
                localStorage.setItem(STORAGE_KEY, sessionId);
            }
            return sessionId;
        }

        // Toggle chatbot window
        const chatbotInvitation = document.getElementById('chatbotInvitation');
        
        chatbotToggle.addEventListener('click', function() {
            chatbotWindow.classList.toggle('active');
            if (chatbotWindow.classList.contains('active')) {
                chatbotBadge.style.display = 'none';
                chatbotInput.focus();
                // Hide invitation when chat opens
                if (chatbotInvitation) {
                    chatbotInvitation.style.display = 'none';
                }
            } else {
                // Show invitation again when chat closes
                if (chatbotInvitation) {
                    chatbotInvitation.style.display = 'block';
                }
            }
        });

        chatbotClose.addEventListener('click', function() {
            chatbotWindow.classList.remove('active');
        });

        // Send message function
        function sendMessage() {
            const message = chatbotInput.value.trim();
            if (!message) return;

            // Add user message to chat
            addMessage(message, 'user');
            chatbotInput.value = '';
            chatbotSend.disabled = true;

            // Show loading indicator
            const loadingId = addLoadingMessage();

            // Send to webhook
            const credentials = btoa(`${CHATBOT_USERNAME}:${CHATBOT_PASSWORD}`);
            
            fetch(CHATBOT_WEBHOOK_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'text/event-stream, application/json, text/plain',
                    'Authorization': `Basic ${credentials}`
                },
                body: JSON.stringify({
                    chatInput: message,
                    sessionId: getSessionId()
                })
            })
            .then(async response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                
                // Function to fix numbered lists format in text
                // This function ONLY fixes list formatting, NEVER touches numbers in regular text
                // It only processes lines that are CLEARLY list items (number + parenthesis at start of line)
                const fixNumberedLists = (text) => {
                    if (!text) return text;
                    
                    // Split text into lines to process each line separately
                    const lines = text.split('\n');
                    const fixedLines = lines.map((line) => {
                        // Only process lines that are CLEARLY list items:
                        // - Start with optional whitespace
                        // - Followed by a number
                        // - Followed by a closing parenthesis
                        // - Followed by a space
                        // - Followed by text (usually starting with capital letter for list items)
                        // This pattern ensures we NEVER touch numbers in sentences like "15 dÃ­as"
                        const listItemPattern = /^(\s*)(\d+)\)(\s+)([A-ZÃÃ‰ÃÃ“ÃšÃ‘])/;
                        if (listItemPattern.test(line)) {
                            // This is definitely a list item, convert "1)" to "1. "
                            return line.replace(listItemPattern, '$1$2.$3$4');
                        }
                        
                        // Fix cases like ":)" which might be "1)" that lost the number
                        // Only if followed by capital letter (indicating list item)
                        if (/^\s*:\)\s+[A-ZÃÃ‰ÃÃ“ÃšÃ‘]/.test(line)) {
                            return line.replace(/^\s*:\)\s+/, '1. ');
                        }
                        
                        // Fix cases where there might be a colon or bullet before the number
                        // Only if followed by capital letter
                        if (/^\s*[:â€¢]\s*(\d+)\)\s+[A-ZÃÃ‰ÃÃ“ÃšÃ‘]/.test(line)) {
                            return line.replace(/^\s*[:â€¢]\s*(\d+)\)\s+/, '$1. ');
                        }
                        
                        // Fix standalone ") " that might be left over (parÃ©ntesis sueltos)
                        // Only if it's at the start of a line with no number before it
                        // AND followed by capital letter (indicating it's a list item)
                        if (/^\s*\)\s+[A-ZÃÃ‰ÃÃ“ÃšÃ‘]/.test(line) && !/^\s*\d+\)/.test(line)) {
                            return line.replace(/^\s*\)\s+/, '');
                        }
                        
                        // Return line unchanged - this preserves ALL numbers in regular text
                        return line;
                    });
                    
                    return fixedLines.join('\n');
                };
                
                // Keep loading message visible until we have enough content
                let streamingMessageElement = null;
                let streamingContent = null;
                let hasEnoughContent = false;
                const MIN_CONTENT_LENGTH = 30; // Minimum characters before showing streaming message
                const MIN_LOADING_TIME = 1500; // Minimum time to show loading (1.5 seconds)
                const loadingStartTime = Date.now();
                
                // Process streaming response line by line
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let accumulatedText = '';
                let finalOutput = null;
                let foundFinalOutput = false;
                let lastUpdateTime = 0;
                const UPDATE_INTERVAL = 50; // Update every 50ms for smooth streaming effect
                
                // Function to initialize streaming message when ready
                const initStreamingMessage = () => {
                    if (!streamingMessageElement) {
                        removeLoadingMessage(loadingId);
                        const streamingMessageId = addStreamingMessage();
                        streamingMessageElement = document.getElementById(streamingMessageId);
                        streamingContent = streamingMessageElement.querySelector('.streaming-content');
                        hasEnoughContent = true;
                    }
                };
                
                // Function to update streaming message with throttling
                const updateStreamingMessage = (text) => {
                    const now = Date.now();
                    const elapsedTime = now - loadingStartTime;
                    
                    // Fix numbered lists format before displaying
                    const fixedText = fixNumberedLists(text);
                    
                    // Check if we should show streaming message
                    if (!hasEnoughContent && (fixedText.length >= MIN_CONTENT_LENGTH || elapsedTime >= MIN_LOADING_TIME)) {
                        initStreamingMessage();
                    }
                    
                    if (hasEnoughContent && streamingContent && (now - lastUpdateTime >= UPDATE_INTERVAL)) {
                        streamingContent.textContent = fixedText;
                        scrollToBottom();
                        lastUpdateTime = now;
                    }
                };
                
                // Function to force update (for final output)
                const forceUpdateStreamingMessage = (text) => {
                    initStreamingMessage();
                    if (streamingContent) {
                        const fixedText = fixNumberedLists(text);
                        streamingContent.textContent = fixedText;
                        scrollToBottom();
                    }
                };
                
                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) break;
                    
                    // Decode chunk and add to buffer
                    buffer += decoder.decode(value, { stream: true });
                    
                    // Process complete lines (NDJSON format)
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || ''; // Keep incomplete line in buffer
                    
                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        if (!trimmedLine) continue;
                        
                        try {
                            const chunk = JSON.parse(trimmedLine);
                            
                            // Only process items with content
                            if (chunk.type === 'item' && chunk.content) {
                                // Try to parse content as JSON (it might contain the final output)
                                let shouldAccumulate = true;
                                try {
                                    const contentObj = JSON.parse(chunk.content);
                                    // If content is an object with "output" field, use it as final message
                                    if (contentObj && typeof contentObj === 'object' && !Array.isArray(contentObj) && contentObj.output) {
                                        finalOutput = contentObj.output;
                                        foundFinalOutput = true;
                                        shouldAccumulate = false; // Don't accumulate, we have the final output
                                        // Update streaming message with final output immediately
                                        forceUpdateStreamingMessage(finalOutput);
                                        break; // Found final output, exit inner loop
                                    } else {
                                        // Parsed successfully but it's not an object with output
                                        // It could be a number, string, array, etc. - treat as plain text
                                        shouldAccumulate = true;
                                    }
                                } catch (e) {
                                    // Content is not valid JSON, treat as plain text
                                    shouldAccumulate = true;
                                }
                                
                                // Accumulate content if it should be accumulated
                                if (shouldAccumulate) {
                                    accumulatedText += chunk.content;
                                    // Update streaming message progressively
                                    updateStreamingMessage(accumulatedText);
                                    // Small delay to make streaming effect visible
                                    await new Promise(resolve => setTimeout(resolve, 10));
                                }
                            }
                        } catch (e) {
                            // Skip invalid JSON lines
                            continue;
                        }
                    }
                    
                    // If we found final output, stop reading
                    if (foundFinalOutput) break;
                }
                
                // Process any remaining buffer
                if (buffer.trim() && !foundFinalOutput) {
                    try {
                        const chunk = JSON.parse(buffer.trim());
                        if (chunk.type === 'item' && chunk.content) {
                            try {
                                const contentObj = JSON.parse(chunk.content);
                                if (contentObj && typeof contentObj === 'object' && contentObj.output) {
                                    finalOutput = contentObj.output;
                                    foundFinalOutput = true;
                                }
                            } catch (e) {
                                accumulatedText += chunk.content;
                            }
                        }
                    } catch (e) {
                        // Ignore
                    }
                }
                
                // Final update: use final output if found, otherwise use accumulated text
                let finalMessage = '';
                if (foundFinalOutput && finalOutput) {
                    finalMessage = finalOutput;
                } else if (accumulatedText) {
                    finalMessage = accumulatedText.trim();
                } else {
                    // No message found, show error
                    removeLoadingMessage(loadingId);
                    addMessage('Lo siento, no pude procesar tu mensaje.', 'bot');
                    return;
                }
                
                // Ensure streaming message is initialized
                initStreamingMessage();
                
                // Pre-process message to fix numbered lists format
                // This function is very conservative and only fixes clear list items
                finalMessage = fixNumberedLists(finalMessage);
                
                // Render markdown for final message
                if (streamingContent) {
                    if (typeof marked !== 'undefined') {
                        // Configure marked options to preserve content
                        const markedOptions = {
                            breaks: true,
                            gfm: true,
                            pedantic: false
                        };
                        
                        // Parse markdown - this converts **15** to <strong>15</strong>
                        const html = marked.parse(finalMessage, markedOptions);
                        
                        // Sanitize HTML with very permissive settings to preserve all content
                        const sanitized = typeof DOMPurify !== 'undefined' 
                            ? DOMPurify.sanitize(html, {
                                ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'u', 'b', 'i', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'ul', 'ol', 'li', 'blockquote', 'code', 'pre', 'a', 'span', 'div'],
                                ALLOWED_ATTR: ['href', 'target', 'rel', 'class', 'id', 'style'],
                                KEEP_CONTENT: true,
                                // Ensure numbers and text are preserved
                                FORBID_TAGS: [],
                                FORBID_ATTR: []
                            }) 
                            : html;
                        
                        streamingContent.innerHTML = sanitized;
                    } else {
                        streamingContent.textContent = finalMessage;
                    }
                }
                
                // Convert streaming message to regular message
                if (streamingMessageElement && streamingMessageElement.parentNode) {
                    streamingMessageElement.classList.remove('chatbot-message-streaming');
                    streamingMessageElement.classList.add('chatbot-message-bot');
                }
                
                scrollToBottom();
            })
            .catch(error => {
                // Remove loading message
                removeLoadingMessage(loadingId);
                
                // Show error message
                addMessage('Lo siento, hubo un error al procesar tu mensaje. Por favor, intenta nuevamente o contÃ¡ctanos directamente.', 'bot');
                console.error('Chatbot error:', error);
            })
            .finally(() => {
                chatbotSend.disabled = false;
                chatbotInput.focus();
            });
        }

        // Add message to chat
        function addMessage(text, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chatbot-message chatbot-message-${type}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            // Render markdown for bot messages, plain text for user messages
            if (type === 'bot' && typeof marked !== 'undefined') {
                // Configure marked options
                const markedOptions = {
                    breaks: true,
                    gfm: true,
                    pedantic: false
                };
                
                // Convert markdown to HTML
                const html = marked.parse(text, markedOptions);
                
                // Sanitize with permissive settings to preserve all content including numbers
                const sanitized = typeof DOMPurify !== 'undefined' 
                    ? DOMPurify.sanitize(html, {
                        ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'u', 'b', 'i', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'ul', 'ol', 'li', 'blockquote', 'code', 'pre', 'a', 'span', 'div'],
                        ALLOWED_ATTR: ['href', 'target', 'rel', 'class', 'id', 'style'],
                        KEEP_CONTENT: true,
                        FORBID_TAGS: [],
                        FORBID_ATTR: []
                    }) 
                    : html;
                contentDiv.innerHTML = sanitized;
            } else {
                // Plain text for user messages
                const p = document.createElement('p');
                p.textContent = text;
                contentDiv.appendChild(p);
            }
            
            messageDiv.appendChild(contentDiv);
            chatbotMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            scrollToBottom();
        }

        // Add loading message
        function addLoadingMessage() {
            const loadingId = 'loading-' + Date.now();
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chatbot-message chatbot-message-bot';
            messageDiv.id = loadingId;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'chatbot-message-loading';
            contentDiv.innerHTML = '<span></span><span></span><span></span>';
            
            messageDiv.appendChild(contentDiv);
            chatbotMessages.appendChild(messageDiv);
            
            scrollToBottom();
            return loadingId;
        }

        // Add streaming message (for real-time updates)
        function addStreamingMessage() {
            const streamingId = 'streaming-' + Date.now();
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chatbot-message chatbot-message-bot chatbot-message-streaming';
            messageDiv.id = streamingId;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const streamingContent = document.createElement('div');
            streamingContent.className = 'streaming-content';
            streamingContent.textContent = '';
            
            contentDiv.appendChild(streamingContent);
            messageDiv.appendChild(contentDiv);
            chatbotMessages.appendChild(messageDiv);
            
            scrollToBottom();
            return streamingId;
        }

        // Remove loading message
        function removeLoadingMessage(loadingId) {
            const loadingElement = document.getElementById(loadingId);
            if (loadingElement) {
                loadingElement.remove();
            }
        }

        // Scroll to bottom of messages
        function scrollToBottom() {
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        }

        // Send message on button click
        chatbotSend.addEventListener('click', sendMessage);

        // Send message on Enter key
        chatbotInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Show badge when window is closed and there are unread messages
        let unreadCount = 0;
        chatbotClose.addEventListener('click', function() {
            if (unreadCount > 0) {
                chatbotBadge.textContent = unreadCount;
                chatbotBadge.style.display = 'flex';
            }
        });
    </script>
</body>
</html>
